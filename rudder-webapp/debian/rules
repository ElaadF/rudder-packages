#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

build: java8
	dh_testdir
	# Build Virtualenv
	cd SOURCES && make build
	touch $@

clean:
	dh_testdir
	dh_testroot
	rm -f build install
	cd SOURCES && make clean
	dh_clean

# dirty hack, don't do this, if your builder comes with java preinstalled you can remove this
# TODO remove as soon as possible
java8:
	dpkg -l | egrep "openjdk-8-jdk|oracle-java8-installer" || ( echo "Installing JDK"; \
		dist=$$(grep '^deb' /etc/apt/sources.list | grep -v backports | head -n1  | LANG=C perl -pe 's/^deb .*? (\w+) .*/$$1/') ;\
		if [ $$dist = "xenial" ] || [ $$dist = "stretch" ] || [ $$dist = "bionic" ]; then \
			DEBIAN_FRONTEND=noninteractive apt-get install -y openjdk-8-jdk; \
		elif [ $$dist = "jessie" ]; then \
			echo "deb http://ftp.fr.debian.org/debian/ jessie-backports main" > /etc/apt/sources.list.d/openjdk.list ; \
			apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -t jessie-backports install -y openjdk-8-jdk ; \
		fi \
	)

install: build
	dh_testdir
	dh_testroot
	cd SOURCES && make install DESTDIR=$(CURDIR)/debian/rudder-webapp

# Default rule that guess what to do for missing targets
%:
	dh $@
