From e52c29873f85703b3ed8bff84407ba7df38bb1f1 Mon Sep 17 00:00:00 2001
From: Nicolas Charles <nicolas.charles@normation.com>
Date: Fri, 1 Feb 2019 12:09:50 +0100
Subject: [PATCH] Fixes #14200 - correct usage of os-release as a fallback

---
 .../Agent/Task/Inventory/Linux/Distro/NonLSB.pm    | 24 ++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/lib/FusionInventory/Agent/Task/Inventory/Linux/Distro/NonLSB.pm b/lib/FusionInventory/Agent/Task/Inventory/Linux/Distro/NonLSB.pm
index ac0afc7..73829d2 100644
--- a/lib/FusionInventory/Agent/Task/Inventory/Linux/Distro/NonLSB.pm
+++ b/lib/FusionInventory/Agent/Task/Inventory/Linux/Distro/NonLSB.pm
@@ -54,6 +54,9 @@ my @distributions = (
     # trustix-release contains something like "Trustix Secure Linux release 2.0 (Cloud)"
     [ '/etc/trustix-release',   'Trustix',                    'release ([\d.]+)', '%s' ],
 
+    # Fallback to os-release when available
+    [ '/etc/os-release',        'Unknown Linux distribution', '([\d.]+)'        , '%s' ],
+
     # Fallback
     [ '/etc/issue',             'Unknown Linux distribution', '([\d.]+)'        , '%s' ],
 
@@ -111,6 +114,27 @@ sub _getDistroData {
         }
     }
 
+    # if this is a os-release fallback, we can extract knowledge there
+    if ($distribution->[0] eq '/etc/os-release') {
+        my $handle = getFileHandle(
+            file => '/etc/os-release',
+        );
+
+        my $version_id;
+        while (my $line = <$handle>) {
+            $name        = $1 if $line =~ /^NAME="?([^"]+)"?/;
+            $version     = $1 if $line =~ /^VERSION="?([^"]+)"?/;
+            $version_id  = $1 if $line =~ /^VERSION_ID="?([^"]+)"?/;
+            $release     = $1 if $line =~ /^PRETTY_NAME="?([^"]+)"?/;
+        }
+        close $handle;
+
+        if ($name =~ /SLES/) {
+            $name = 'SuSE';
+        }
+    }
+
+
     my $data = {
         NAME      => $name,
         VERSION   => $version,
-- 
2.7.4

