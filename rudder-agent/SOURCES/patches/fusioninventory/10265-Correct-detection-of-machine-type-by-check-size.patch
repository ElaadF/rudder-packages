From 615803fe85683a201f678d664465b2c9a22a2eca Mon Sep 17 00:00:00 2001
From: Nicolas Charles <nicolas.charles@normation.com>
Date: Fri, 26 Oct 2018 15:36:41 +0200
Subject: [PATCH] Fixes #593: Correct detection of machine type by checking
 size of /var/log/dmesg

---
 lib/FusionInventory/Agent/Task/Inventory/Virtualization/Vmsystem.pm | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lib/FusionInventory/Agent/Task/Inventory/Virtualization/Vmsystem.pm b/lib/FusionInventory/Agent/Task/Inventory/Virtualization/Vmsystem.pm
index b792beb..563ce0e 100644
--- a/lib/FusionInventory/Agent/Task/Inventory/Virtualization/Vmsystem.pm
+++ b/lib/FusionInventory/Agent/Task/Inventory/Virtualization/Vmsystem.pm
@@ -207,9 +207,10 @@ sub _getType {
     return $result if $result;
 
     # dmesg
+    # dmesg can be empty or near empty on some systems (notably on Debian 8)
 
     my $handle;
-    if (-r '/var/log/dmesg') {
+    if (-r '/var/log/dmesg' && -s '/var/log/dmesg' > 40) {
         $handle = getFileHandle(file => '/var/log/dmesg', logger => $logger);
     } elsif (-x '/bin/dmesg') {
         $handle = getFileHandle(command => '/bin/dmesg', logger => $logger);
-- 
2.7.4

